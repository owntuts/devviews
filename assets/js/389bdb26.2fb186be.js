"use strict";(self.webpackChunkinterviewdev=self.webpackChunkinterviewdev||[]).push([[8812],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return h}});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=r.createContext({}),c=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},d=function(e){var n=c(e.components);return r.createElement(l.Provider,{value:n},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,s=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=c(t),m=o,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||s;return t?r.createElement(h,a(a({ref:n},d),{},{components:t})):r.createElement(h,a({ref:n},d))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var s=t.length,a=new Array(s);a[0]=m;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[u]="string"==typeof e?e:o,a[1]=i;for(var c=2;c<s;c++)a[c]=t[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},5642:function(e,n,t){t.r(n),t.d(n,{assets:function(){return l},contentTitle:function(){return a},default:function(){return p},frontMatter:function(){return s},metadata:function(){return i},toc:function(){return c}});var r=t(3117),o=(t(7294),t(3905));const s={sidebar_position:1e3,sidebar_label:"Nodejs Cluster",title:"Nodejs Cluster",tags:["Nodejs Knowledge"]},a=void 0,i={unversionedId:"nodejs/nodejs/cluster",id:"nodejs/nodejs/cluster",title:"Nodejs Cluster",description:"Cluster in Nodejs",source:"@site/docs/nodejs/nodejs/cluster.md",sourceDirName:"nodejs/nodejs",slug:"/nodejs/nodejs/cluster",permalink:"/devviews/interviews/nodejs/nodejs/cluster",draft:!1,editUrl:"https://github.com/owntuts/devviews/edit/main/docs/nodejs/nodejs/cluster.md",tags:[{label:"Nodejs Knowledge",permalink:"/devviews/interviews/tags/nodejs-knowledge"}],version:"current",sidebarPosition:1e3,frontMatter:{sidebar_position:1e3,sidebar_label:"Nodejs Cluster",title:"Nodejs Cluster",tags:["Nodejs Knowledge"]},sidebar:"nodejsInterviewSidebar",previous:{title:"Nodejs Child Process",permalink:"/devviews/interviews/nodejs/nodejs/child-process"},next:{title:"Nodejs Stream Events & Functions",permalink:"/devviews/interviews/nodejs/nodejs/common-stream-events"}},l={},c=[{value:"Examples of Communication",id:"examples-of-communication",level:4}],d={toc:c},u="wrapper";function p(e){let{components:n,...s}=e;return(0,o.kt)(u,(0,r.Z)({},d,s,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("details",{open:!0},(0,o.kt)("summary",null,(0,o.kt)("h5",null,"Cluster in Nodejs")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Nodejs cluster")," is a module that allows you to create multiple child processes that run parallelly and share the same server port. This module can be used to ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"take advantage of multi-core systems"))," and distribute workloads among the processes. The ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"child processes have their own memory, event loop, and V8 instance, and communicate with the parent process via IPC")),". The cluster module acts as a load balancer that can handle blocking code and improve performance."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Cluster in Nodejs",src:t(7886).Z,width:"830",height:"467"})),(0,o.kt)("p",null,"Here is an example of how to use nodejs cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// Import the cluster module\nimport cluster from 'node:cluster';\n// Get the number of available CPUs\nimport { availableParallelism } from 'node:os';\nconst numCPUs = availableParallelism();\n\n// Check if the current process is the primary process\nif (cluster.isPrimary) {\n  // Log the primary process ID\n  console.log(`Primary ${process.pid} is running`);\n\n  // Fork workers for each CPU\n  for (let i = 0; i < numCPUs; i++) {\n    cluster.fork();\n  }\n\n  // Communication to Workers\n  cluster.on('fork', (worker) => {\n    console.log('Primary forked worker: ', worker.id);\n    worker.send({msg: 'Hello worker'});\n  });\n\n  // Listen for exit events from workers\n  cluster.on('exit', (worker, code, signal) => {\n    console.log(`worker ${worker.process.pid} died`);\n  });\n} else {\n  // Create an HTTP server in each worker process\n  import http from 'node:http';\n  http.createServer((req, res) => {\n    res.writeHead(200);\n    res.end('hello world\\n');\n  }).listen(8000);\n\n  // Log the worker process ID\n  console.log(`Worker ${process.pid} started`);\n\n  // Communication to Primary\n  process.on('message', (msg) => {\n    console.log('Worker received: ', msg);\n  });\n\n}\n")),(0,o.kt)("p",null,":::note\nIt depends on the nodejs version you are using. Nodejs cluster module supports two methods of distributing incoming connections: ",(0,o.kt)("strong",{parentName:"p"},"round-robin")," and ",(0,o.kt)("strong",{parentName:"p"},"OS scheduling"),"."),(0,o.kt)("p",null,"You can check or change the scheduling policy by using ",(0,o.kt)("inlineCode",{parentName:"p"},"cluster.schedulingPolicy")," property\xb9. The possible values are ",(0,o.kt)("inlineCode",{parentName:"p"},"cluster.SCHED_RR")," for round-robin or ",(0,o.kt)("inlineCode",{parentName:"p"},"cluster.SCHED_NONE")," for OS scheduling\xb9."),(0,o.kt)("p",null,":::")),(0,o.kt)("details",{open:!0},(0,o.kt)("summary",null,(0,o.kt)("h5",null,"Cluster Communication")),"You can use events. There are several events that can be emitted by the cluster module. Some of them are:",(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('fork', (worker) => {})"),": This event is emitted when a new worker is forked by the primary process."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('online', (worker) => {})"),": This event is emitted when a worker has started and is ready to receive messages from the primary process."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('listening', (worker, address) => {})"),": This event is emitted when a worker is listening for connections on a server port\xb9. The address object contains the address, port and address type of the server."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('disconnect', (worker) => {})"),": This event is emitted when the IPC channel between a worker and the primary process has disconnected. This can happen when a worker calls ",(0,o.kt)("inlineCode",{parentName:"li"},"process.disconnect()")," or exits gracefully."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('exit', (worker, code, signal) => {})"),": This event is emitted when a worker exits or is killed by a signal. The code and signal arguments contain the exit code and signal name of the worker process, if any."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('message', (worker, message, handle) => {})"),": This event is emitted when a worker sends a message to the primary process via ",(0,o.kt)("inlineCode",{parentName:"li"},"process.send()"),". The message argument contains the message object and the handle argument contains an optional handle object for sending file descriptors."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"cluster.on('setup', (settings) => {})"),": This event is emitted when ",(0,o.kt)("inlineCode",{parentName:"li"},".setupPrimary()")," is called or when a new worker is forked for the first time. The settings argument contains the cluster settings object that was passed to ",(0,o.kt)("inlineCode",{parentName:"li"},".setupPrimary()")," or that was generated by default.")),(0,o.kt)("p",null,"These are some of the cluster events that can be listened by the primary process. You can find more details and examples in the documentation of nodejs cluster."),(0,o.kt)("h4",{id:"examples-of-communication"},"Examples of Communication"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// In the primary process\n// Fork workers for each CPU\nfor (let i = 0; i < numCPUs; i++) {\n  cluster.fork();\n}\n\n// Do something async and then send a message to workers\nfetch('https://example.com/api')\n  .then(res => res.json())\n  .then(data => {\n    console.log('Primary fetched data: ', data);\n    // Send a message to each worker\n    for (const id in cluster.workers) {\n      cluster.workers[id].send({msg: 'Hello worker'});\n    }\n  })\n  .catch(err => console.error(err));\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  // In workers\n  process.on('message', (msg) => {\n    console.log('Worker received: ', msg);\n  });\n")),(0,o.kt)("p",null,":::note"),(0,o.kt)("p",null,"You can also use socket.io or node-ipc to create a bidirectional communication channel between the processes."),(0,o.kt)("p",null,":::")))}p.isMDXComponent=!0},7886:function(e,n,t){n.Z=t.p+"assets/images/cluster-63ae52454c74ef9147de54cac8a448d7.png"}}]);